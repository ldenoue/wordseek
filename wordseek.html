<html lang='en' manifest='wordseek.appcache'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'>
<meta name='apple-mobile-web-app-title' content='WordSeek'>
<link rel='apple-touch-icon' sizes='192x192' href='icon.png'>
<link rel='icon' href='icon.png'>
<title>WordSeek</title>
<style>
@font-face {
  font-family: 'Ubuntu';
  font-style: normal;
  font-weight: 400;
  src: local('Ubuntu Regular'), local('Ubuntu-Regular'), url('ubuntu.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2212, U+2215;
}

* {
overflow:hidden;
box-sizing:content-box;
margin:0;
padding:0;
font-size:16px;
font-weight:normal;
font-family:'Ubuntu',Helvetica,monospace;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;

}
body{
background-color:#294;
user-select:none;
-webkit-touch-callout: none; /* iOS Safari */
-webkit-user-select: none; /* Safari */
background-repeat: no-repeat;
background-size: cover;
}

.highlighted { background-color: yellow;}
.word{display:inline-block;margin:8px;}
.wordicon{font-size:60px}
.wordicon > img {padding:8px}
.wordicon > img {width:80px;height:80px}
.realword{font-size:20px}

.crossed {opacity:0.5;color:#555;}

text{
  pointer-events:none;/* prevents it from stealing events from rects */
  font-size:36px;
  fill:black;
  opacity:1.0;
  /*transition: opacity 0.2s ease-out;*/
}

line{
  stroke-width:48;
}

@keyframes winAnimation {
  0%   { opacity:0; transform:scale(0.3)}
  50%  { opacity:0.5; transform:scale(1.0)}
  100% { opacity:0; transform:scale(1.3)}
}

#hint{
  pointer-events:none;
  opacity:0;
  position:absolute;
  width:56px;height:56px;
  background-color:#2FABF9;
  border-radius:50%;
  left:8px;top:-8px;
  animation: hintAnimation 0.5s ease-out;
  animation-iteration-count: 2;
  animation-delay:0.3s;
}

#win{
  pointer-events:none;/* would steal events from grid without */
  opacity:0;
  position:absolute;
  width:128px;
  height:128px;
  background-color:white;
  border-radius:50%;
  border:0px solid white;
  font-size:48px;
  color:white;
  background-color:yellow;
  text-align:center;
  line-height:128px;
}

.zoom{animation: winAnimation 0.9s ease-out}

#grid{
padding:4px;
height:400px;
max-height:calc(100vw - 64px);
max-width:calc(100vw - 64px);
border:0px solid blue;
border-radius:24px;
background-color:white;
transition: opacity 1s ease-in-out;
}

#container{
width:100vw;height:100%;
position:fixed;
left:0px;
top:0px;
display:flex;
flex-direction:column;
align-items: center;
text-align:center;
justify-content: space-evenly;
}

.item{align-self:center}

#header{
  position:fixed;
  width:100vw;
  top:0px;
  left:0px;
  margin:0px;
  padding:0;
  font-size:22px;
}

.topbutton{
  /*background-color:rgba(255,255,255,0.2);
  margin:4px;*/
  padding:8px;
  border-radius:5px;
  cursor:pointer;
  color:black;
  font-size:16px;
  min-width:64px;
  text-align:center;
}

#totalwordsdiv{float:left;}
#highscorediv{float:right;}

.solutionrect { opacity:0.9; transition: opacity 1s ease-in-out}

#help{
  cursor:pointer;
  
  position:fixed;
  right:2;
  bottom:2;
}

#reset{
  cursor:pointer;
  font-size:22px;
  position:fixed;
  left:2;
  bottom:2;
}

#confirmdialog{
  position: fixed;
  display:none;
  flex-direction:column;
  align-items: center;
  text-align:center;
  justify-content: space-evenly;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.8);
  text-align:center;
  transition:opacity 0.2s ease-in-out;
  opacity:0;
}

#dialog{
  border-radius:8px;
  align-self:center;
  background-color:white;
  padding:32px;
}
#dialog div {font-size:16px}
button{cursor:pointer;font-family:Ubuntu;text-transform:uppercase;outline:none;
border-radius:5px;
border:0px solid black;
background-color:tomato;
padding:8px;margin:8px;
font-size:16px;
min-width:60px;
color:white;
font-variant: small-caps;
}
menu{padding:16px}


@media only screen and (orientation:landscape) {
  #container{flex-direction:row;}
  .word{display:block;}
  .wordicon{font-size:48px;}
  .wordicon > img {width:48px;height:48px}
  .realword{font-size:18px;}
  #grid{
    max-height:calc(100vh - 64px);
    height:400px;
    max-width:calc(100vh - 64px);
  }
  #questions1,#questions2{min-width:120px}
}

@media only screen and (orientation:landscape) and (min-width:800px) {
  .wordicon{font-size:80px;}
  .wordicon > img {width:80px;height:80px}
}

@media only screen and (max-width:400px) {
  .wordicon{font-size:40px}
  .wordicon > img {width:40px;height:40px}
  .realword{font-size:16px}
  #grid{height:400px;max-width:calc(100vw-32px);max-height:calc(100vw-32px))}
}

@media only screen and (min-width:800px) and (min-height:800px) {
    .wordicon{font-size:120px}
    .wordicon > img {width:120px;height:120px}
    .realword{font-size:32px}
    .topbutton{font-size:32px;}
    #grid{height:640px;max-width:calc(100vw-32px);max-height:calc(100vw-32px))}
    #questions1,#questions2{min-width:200px}
}

</style>
<script src='emojis.js'></script>
</head>
<body onload='init()'>
<div id='container'>
  <div class='item' id='questions1'></div>
  <svg class='item' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xml:space='preserve' id='grid'></svg>
  <div class='item' id='questions2'></div>
</div>
<div id='win'>1</div>
<div id='header'><div id='totalwordsdiv' class='topbutton'>0 words</div><div id='highscorediv' class='topbutton'>0</div></div>
<div id='confirmdialog'>
  <div id='dialog' class="hideDialog">
    <div>Reset score?</div>
    <menu>
        <button id='cancelbutton'>Cancel</button>
        <button id='resetbutton'>Reset</button>
    </menu>
  </div>
</div>
<script>
'use strict';
var firstTime = true;
var audioCoin = null;
var audioCoin2 = null;
var audioWin = null;

var useTwitterEmoji = true;
var HORIZONTAL = 0;
var VERTICAL = 1;
var DIAGONAL = 2;
var lastSelection = null;
var score = 0;
var totalWords = 0;
var startEvent = 'mousedown';
var endEvent = 'mouseup';
var moveEvent = 'mousemove';
var outEvent = 'mouseleave';
var isMouseDown = false;
var backColor = null;
var isNewGame = false;
var bgColors = '#2FABF9,#F2C03A,#DB2E29,#9280F9'.split(',');
var hiColors = 'yellow,#3BDB29,#2FABF9,#F2C03A,#DB2E29,#9280F9'.split(',');
var currentColor = 0;
var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
var points = {"a":1,"b":3,"c":3,"d":2,"e":1,"f":4,"g":2,"h":4,"i":1,"j":8,"k":5,"l":1,"m":3,"n":1,"o":1,"p":3,"q":10,"r":1,"s":1,"t":1,"u":1,"v":4,"w":4,"x":8,"y":4,"z":10};
var words_emojis = [];
var gamew = 9;
var gameh = 9;
var nQuestions = 6;
var nFound = 0;
var matrix = new Array(gameh);
var first = null;
var solution = new Array();

var categories = Object.keys(emojis);
var words = [];
var found_words = [];
var category = categories[0];
var names = Object.keys(emojis[category]);

function dismissDialog(yes)
{
  confirmdialog.style.opacity = 0;
  if (yes)
  {
    score = 0;
    totalWords = 0;
    setScore(score);
    setTotalWords(totalWords);
  }
  return false;
}

function $(id)
{
	return document.getElementById(id);
}

function rnd(n)
{
	return Math.floor(Math.random()*n);
}

function goodPos(x,y,word,direction)
{
  if (direction === HORIZONTAL)
  {
    for (var i=x;i<x+word.length;i++)
    {
      if (matrix[y][i] != ' ')
        return false;
    }
  	return true;
  }
  else if (direction === VERTICAL)
  {
    for (var j=y;j<y+word.length;j++)
    {
      if (matrix[j][x] != ' ')
        return false;
    }
  	return true;
  }
  else if (direction === DIAGONAL)
  {
    var top = y;
    for (var i=x;i<x+word.length;i++)
    {
      if (matrix[top][i] != ' ')
        return false;
      top++;
    }
  	return true;
  }
}

function placeWord(x,y,w,direction)
{
  if (direction === HORIZONTAL)
  {
    for (var i=x;i<x+w.length;i++)
    {
      matrix[y][i] = w.charAt(i-x);
    }
  	solution[w] = {x1:x,y1:y,x2:x+w.length-1,y2:y};
  }
  else if (direction === VERTICAL)
  {
    for (var j=y;j<y+w.length;j++)
    {
      matrix[j][x] = w.charAt(j-y);
    }
    solution[w] = {x1:x,y1:y,x2:x,y2:y+w.length-1};
  }
  else if (direction === DIAGONAL)
  {
    var left = x;
    for (var j=y;j<y+w.length;j++)
    {
      matrix[j][left] = w.charAt(j-y);
      left++;
    }
    solution[w] = {x1:x,y1:y,x2:x+w.length-1,y2:y+w.length-1};
  }
}

function highlightSelection(x1,y1,x2,y2)
{
  lastSelection = [x1,y1,x2,y2];
  selectionline.setAttribute('x1',x1*48+24);
  selectionline.setAttribute('y1',y1*48+24);
  selectionline.setAttribute('x2',x2*48+24);
  selectionline.setAttribute('y2',y2*48+24);
}

function showWin(n,x1,y1,x2,y2)
{
  var pos = getPosition((x1+x2+1)/2,(y1+y2)/2);
  pos.x -= win.offsetWidth / 2;
  pos.y -= win.offsetHeight / 2;
  pos.x |= 0;
  pos.y |= 0;
  win.style.left = pos.x + 'px';
  win.style.top = pos.y + 'px';
  win.textContent = '+' + n;
  win.classList.add('zoom');
  setTimeout(function () { win.classList.remove('zoom')},900);
}

function checkWord(coords)
{
  var x1 = coords[0];
  var y1 = coords[1];
  var x2 = coords[2];
  var y2 = coords[3];
  if (x1 > x2)
    return checkWord([x2,y2,x1,y1]);
  if (y1 > y2)
    return checkWord([x2,y2,x1,y1]);
  first = null;
  var textselection = '';
  if (y1 === y2)
  {
    for (var x=x1;x<=x2;x++)
      textselection += matrix[y1][x];
  }
  else if (x1 === x2)
  {
    for (var y=y1;y<=y2;y++)
      textselection += matrix[y][x1];
  }
  else
  {
    var y = y1;
    for (var x=x1;x<=x2;x++)
    {
      textselection += matrix[y][x];
      y++;
    }
  }
  var found = -1;
  if (found_words.indexOf(textselection) !== -1)
  {
    return;
  }
  for (var i=0;i<words.length;i++)
  {
    if (textselection === words[i])
    {
      found = i;
      break;
    }
  }
  if (found >= 0)
  {
    found_words.push(textselection);
    var lineSolution = document.querySelector('#solutionrect' + found);
    lineSolution.dataset.done = 'true';
    lineSolution.setAttribute('x1',x1*48+24);
    lineSolution.setAttribute('y1',y1*48+24);
    lineSolution.setAttribute('x2',x2*48+24);
    lineSolution.setAttribute('y2',y2*48+24);
    lineSolution.style.visibility = 'visible';

    first = null;
    var elem = null
    for (var i=0;i<words.length;i++)
    {
      elem = $('word' + i);
      var realword = elem.querySelector('.realword');
      if (realword.textContent === textselection)
      {
        elem.classList.add('crossed');
      }
    }
    nFound++;
    var points = pointsForWord(textselection);
    score += points;
    if (points >= 12)
    {
      audioCoin2.currentTime = 0;
      audioCoin2.play();
    }
    else
    {
      audioCoin.currentTime = 0;
      audioCoin.play();
    }
    setScore(score);
    showWin(points,x1,y1,x2,y2);
    totalWords++;
    setTotalWords(totalWords);
    if (nFound === words.length)
    {
      var rects = document.querySelectorAll('.solutionrect');
      rects.forEach(r => r.style.opacity = 0);
      isNewGame = true;
      audioWin.currentTime = 0;
      audioWin.play();
      setTimeout(function () {init()},1000);
    }
  }
  else
  {
  }
}

function setScore(s)
{
  try {
    window.localStorage.score = s;
  } catch (e) {}
  if (s > 1)
    highscorediv.textContent = score + ' points';
  else
    highscorediv.textContent = score + ' point';
}

function setTotalWords(s)
{
  try {
    window.localStorage.totalWords = s;
  } catch (e) {}
  if (s > 1)
    totalwordsdiv.textContent = totalWords + ' words';
  else
    totalwordsdiv.textContent = totalWords + ' word';
}

function pointsForWord(textselection)
{
  var pts = 0;
  if (!textselection)
    return 0;
  var letters = textselection.trim().toLowerCase().split('');
  for (var i=0;i<letters.length;i++)
  {
    var val = points[letters[i]];
    if (val)
      pts += val;
  }
  return pts;
}

function init()
{
  nFound = 0;
  var elems = document.querySelectorAll('.letter');
  elems.forEach(a => delete a.dataset.done);

  currentColor = parseInt(Math.random() * hiColors.length);
  backColor = bgColors[new Date%bgColors.length];
  document.body.style.backgroundColor = backColor;
  document.querySelectorAll('button').forEach((b) => b.style.backgroundColor = backColor);
	words = [];
	found_words = [];
	words_emojis = [];
	while (words.length < nQuestions)
	{
    var idx = parseInt(Math.random()*names.length);
	  
	  var name = names[idx];
      var emoji = emojis[category][name];
	  if (name.length < gamew && name.length < gameh && name.indexOf(' ') === -1 && name.indexOf('-') !== 0 && words.indexOf(name.toUpperCase()) === -1)
	  {
      words.push(name.toUpperCase());
      if (useTwitterEmoji)
      {
        var hexcode = hexCodeFromEmoji(emoji);
        words_emojis.push('<img src="svg/' + hexcode + '.svg">');
      }
      else
        words_emojis.push(emoji);
    }
	}
	solution = [];
	initReal();
}

function initReal()
{
	for (var j=0;j<gameh;j++)
	{
		matrix[j] = new Array(gamew);
		for (var i=0;i<gamew;i++)
		{
			matrix[j][i] = ' ';
		}
	}

	var maxtries = 500;
	var ndiagonals = 0;
	var missing = [];
	for (var i=0;i<words.length;i++)
	{
		var done = false;
		var ntries = 0;
		while (ntries<maxtries && !done)
		{
			ntries++;
			var word = words[i];
			var direction = 0;
			if (ndiagonals >= 2)
			  direction = rnd(2);
			else
			  direction = rnd(3);
			var x = 0
			var y = 0;
			if (direction === HORIZONTAL)
			{
			  x = rnd(gamew-word.length);
			  y = rnd(gameh);
			}
			else if (direction === VERTICAL)
			{
			  x = rnd(gamew);
			  y = rnd(gameh-word.length);
			}
			else
			{
			  ndiagonals++;
			  x = rnd(gamew-word.length);
			  y = rnd(gameh-word.length);
			}
			if (goodPos(x,y,word,direction))
			{
				placeWord(x,y,word,direction);
				done = true;
			}
		}
		if (!done)
			missing.push(words[i]);
	}
	if (missing.length > 0)
    console.log('some words not placed',missing);
  for (var i=0;i<words.length;i++)
  {
    if (missing.indexOf(words[i]) !== -1)
      words[i] = null;
  }
  words = words.filter(w => w !== null);
	for (var j=0;j<gameh;j++)
	{
		for (var i=0;i<gamew;i++)
		{
			if (matrix[j][i] === ' ')
				matrix[j][i] = letters[rnd(26)];
		}
	}

  var size = gamew * 48;
  
	var html = '';
  var color = 0;
  var solutionid = 0;
	for (var w in solution)
	{
	  var x1 = 48 * solution[w].x1+24;
	  var y1 = 48 * solution[w].y1+24;
    var x2 = 48 * solution[w].x2+24;
    var y2 = 48 * solution[w].y2+24;
	  var fillColor = hiColors[color%hiColors.length];
    html += '<line class="solutionrect" id=solutionrect' + solutionid + ' stroke-linecap="round" style="visibility:hidden;stroke:' + fillColor + '" x1=' + x1 + ' y1=' + y1 + ' x2=' + x2 + ' y2=' + y2 + ' />';
	  color++;
	  solutionid++;
	}
  html += '<line id="selectionline" x1="0" y1="0" x2="200" y2="200" stroke-linecap="round" style="visibility:hidden;stroke:rgb(255,255,0)" />';
	for (var j=0;j<gameh;j++)
	{
		for (var i=0;i<gamew;i++)
		{
      html += '<rect fill="transparent" id=cell' + j + '_'+ i + ' data-i='+ i + ' data-j=' + j + ' class="letter" width="50px" height="48px" x="' + (i * 48) + '" y="' + (j * 48) + '" />';
      //html += '<text style="transition: opacity ' + rnd(30)/50+'s ease-out;" text-anchor="middle" alignment-baseline="middle" x="' + (i * 48+24) + '" y="' + (j * 48+24) + '">' + matrix[j][i] + '</text>';
      html += '<text text-anchor="middle" alignment-baseline="middle" x="' + (i * 48+24) + '" y="' + (j * 48+24) + '">' + matrix[j][i] + '</text>';
		}
	}
	grid.innerHTML = html;
	grid.setAttribute('viewBox','0 0 ' + size + ' ' + size);

  win.style.backgroundColor = backColor;

	html = '';
	for (var i=0;i<words.length/2;i++)
		html += '<div id=word' + i + ' class=word><div class="wordicon">' + words_emojis[i] + '</div><div class=realword>' + words[i] + '</div></div> ';
	questions1.innerHTML = html;
	html = '';
	for (var i=nQuestions/2;i<words.length;i++)
		html += '<div id=word' + i + ' class=word><div class="wordicon">' + words_emojis[i] + '</div><div class=realword>' + words[i] + '</div></div> ';
  questions2.innerHTML = html;
  
  grid.style.opacity = 1.0;
}

function solve()
{
  var solutions = document.querySelectorAll('.solutionrect');
  solutions.forEach(s => s.style.visibility = 'visible');
}

function unsolve()
{
  var solutions = document.querySelectorAll('.solutionrect');
  solutions.forEach(s => {if (!s.dataset.done) s.style.visibility = 'hidden'});
}

if ('ontouchstart' in document.documentElement)
{
  startEvent = 'touchstart';
  endEvent = 'touchend';
  outEvent = 'touchleave';
  moveEvent = 'touchmove';
}

function getPosition(x,y) {
  var rect = grid.getBoundingClientRect();
  return {
    x:rect.left + rect.width * x / gamew,
    y:rect.top + rect.height * y / gameh
  };
}

function loadSounds()
{
  audioCoin = new Audio('coin.mp3');
  audioCoin2 = new Audio('win.mp3');
  audioWin = new Audio('endgame.mp3');
}

document.body.addEventListener(startEvent,function (e){
  if (firstTime)
  {
    firstTime = false;
    loadSounds();
  }
  init();
});

confirmdialog.addEventListener(startEvent,function (e){
  e.preventDefault();
  e.stopPropagation();
  dismissDialog(false);
});

cancelbutton.addEventListener(startEvent, function (e) {
  dismissDialog(false);
});

resetbutton.addEventListener(startEvent, function (e) {
  dismissDialog(true);
});

confirmdialog.addEventListener('transitionend',function (e) {
  var opacity = +e.target.style.opacity;
  if (opacity === 0)
    confirmdialog.style.display = 'none';
  else if (opacity === 1)
    confirmdialog.style.display = 'flex';
});

document.addEventListener('keydown',function(e){
  if (e.key === 'h')
    solve();
  else if (e.key === 'Escape')
    dismissDialog(false);
});

document.addEventListener('keyup',function(e){
    unsolve();
});

/* for some reason, Chrome does not respect user-select without this */
document.body.onselectstart= function () {return false;}

grid.addEventListener(moveEvent, function (e) {
  e.preventDefault();
  if (first === null)
    return;
  var elem = null;
  if (moveEvent === 'mousemove')
  {
    if (!isMouseDown)
      return;
    elem = document.elementFromPoint(e.clientX,e.clientY);
  }
  else
  {
    var clientX = e.touches[0].clientX;
    var clientY = e.touches[0].clientY;
    elem = document.elementFromPoint(clientX,clientY);  
  }
  if (first && elem.classList.contains('letter') && elem.dataset.done !== 'true')
  {
    var x1 = first.x;
    var y1 = first.y;
    var x2 = +elem.dataset.i;
    var y2 = +elem.dataset.j;
    var dx = Math.abs(x2 - x1);
    var dy = Math.abs(y2 - y1);
    if (dx > dy && dy <= 2)
      highlightSelection(x1,y1,x2,y1); // horizontal
    else if (dy > dx && dx <= 2)
      highlightSelection(x1,y1,x1,y2); // vertical
    else if (dx === dy)
      highlightSelection(x1,y1,x2,y2); // diagonal
  }
});

grid.addEventListener(endEvent,function(e) {
  e.preventDefault();
  e.stopPropagation();
  isMouseDown = false;
  if (lastSelection)
    checkWord(lastSelection);
  selectionline.style.visibility = 'hidden';
  lastSelection = null;
});

grid.addEventListener('mouseleave',function(e) {
  isMouseDown = false;
  selectionline.style.visibility = 'hidden';
  lastSelection = null;
});

grid.addEventListener(startEvent, function (e) {
  e.preventDefault();
  e.stopImmediatePropagation();
  if (firstTime)
  {
    firstTime = false;
    loadSounds();
  }

  isMouseDown = true;
  var cell = e.target;
  if (cell.classList.contains('letter') && cell.dataset.done !== 'true')
  {
    first = {x:+cell.dataset.i,y:+cell.dataset.j}; 
    selectionline.style.visibility = 'visible';
    highlightSelection(first.x,first.y,first.x,first.y);
  }
});

totalwordsdiv.addEventListener(startEvent,function(e){
  if (firstTime)
  {
    firstTime = false;
    loadSounds();
  }
  e.preventDefault();
  e.stopPropagation();
  solve();
});

totalwordsdiv.addEventListener(endEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
  unsolve();
});

totalwordsdiv.addEventListener(outEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
  unsolve();
});

highscorediv.addEventListener(endEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
});

highscorediv.addEventListener(startEvent,function(e){
  if (firstTime)
  {
    firstTime = false;
    loadSounds();
  }
  e.preventDefault();
  e.stopPropagation();
  confirmdialog.style.display = 'flex';
  setTimeout(function () {
    confirmdialog.style.opacity = 1;
  },10);
});

try {
  if (window.localStorage && window.localStorage.score)
    score = +window.localStorage.score;
  if (window.localStorage && window.localStorage.totalWords)
    totalWords = +window.localStorage.totalWords;
} catch (e) {}

setScore(score);
setTotalWords(totalWords);

</script>
</body>
</html>
