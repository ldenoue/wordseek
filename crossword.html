<html lang='en'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'>
<meta name='apple-mobile-web-app-title' content='CrossWord'>
<link rel='apple-touch-icon' sizes='192x192' href='crossword-icon.png'>
<link rel='icon' href='crossword-icon.png'>
<title>CrossWord</title>
<style>
@font-face {
  font-family: 'Ubuntu';
  font-style: normal;
  font-weight: 400;
  src: local('Ubuntu Regular'), local('Ubuntu-Regular'), url('ubuntu.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2212, U+2215;
}

* {
overflow:hidden;
margin:0;
padding:0;
font-size:16px;
font-weight:normal;
font-family:'Ubuntu',Helvetica,monospace;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;

}

body{
box-sizing:border-box;
background-color:#294;
user-select:none;
-webkit-touch-callout: none;
-webkit-user-select: none;
background-repeat: no-repeat;
background-size: cover;
}

rect{
	stroke-width:0;stroke:rgb(0,0,0);
	transition: all .2s ease-in;
	cursor:pointer;
}

g{
  transition:all .2s ease-in;
}

text{
  pointer-events:none;
  font-size:36px;
  fill:black;
  opacity:1.0;
  text-anchor:middle;
  alignment-baseline:middle;
}

line{
  stroke-width:48;
}

@keyframes winAnimation {
  0%   { opacity:0; transform:scale(0.3)}
  50%  { opacity:0.5; transform:scale(1.0)}
  100% { opacity:0; transform:scale(1.3)}
}

@keyframes hintAnimation {
  0%   { opacity:0; transform:scale(0.3)}
  50%  { opacity:0.2; transform:scale(1.0)}
  100% { opacity:0; transform:scale(0.3)}
}

#hint{
  pointer-events:none;
  opacity:0;
  position:absolute;
  width:56px;height:56px;
  background-color:#2FABF9;
  border-radius:50%;
  left:8px;top:-8px;
  animation: hintAnimation 0.5s ease-out;
  animation-iteration-count: 2;
  animation-delay:0.3s;
}

#win{
  pointer-events:none;
  opacity:0;
  position:absolute;
  width:128px;
  height:128px;
  background-color:white;
  border-radius:50%;
  border:0px solid white;
  font-size:48px;
  color:white;
  background-color:yellow;
  text-align:center;
  line-height:128px;
}

.zoom{animation: winAnimation 0.9s ease-out}

#grid{
padding:0px;
width:440px;
max-width:calc(100vw - 16px);
transition: opacity 1s ease-in-out;
}

#container{
width:100vw;height:100%;
position:fixed;
left:0px;
top:0px;
display:flex;
flex-direction:column;
align-items: center;
text-align:center;
justify-content: space-evenly;
}

.item{align-self:center}

#header{
  position:fixed;
  width:100vw;
  top:0px;
  left:0px;
  margin:0px;
  padding:0;
  font-size:22px;
}
#totalwordsdiv{cursor:pointer;margin:10px;border-radius:8px;float:left;padding:8px;background-color:rgba(128,128,125,0.2)}
#highscorediv{cursor:pointer;margin:10px;border-radius:8px;float:right;padding:8px;background-color:rgba(128,128,125,0.2)}

.solutionrect { opacity:0.9; transition: opacity 1s ease-in-out}

#help{
  cursor:pointer;
  font-size:22px;
  position:fixed;
  right:2;
  bottom:2;
}

#reset{
  cursor:pointer;
  font-size:22px;
  position:fixed;
  left:2;
  bottom:2;
}

.selected{
  fill:yellow;
}

.highlight{
  transition: all 0.9s ease-out;
  opacity:1.0;
  fill:yellow;
}

.found{
  transition: opacity 0.2s ease-out;
  opacity:0;
}

.emojitext{
  font-size:64px;
  transform:translate(-8px,-8px);
}

.guess{
  opacity:0;
}

.show{opacity:1}

.foundsolution{
  transition: opacity 0.2s ease-out;
  opacity:1;
}
</style>
</head>
<body onload='init()'>
<div id='container'>
  <svg class='item' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xml:space='preserve' id='grid'></svg>
</div>
<div id='win'>1</div>
<div id='header'><div id='totalwordsdiv'>0 words</div><div id='highscorediv'>0 points</div></div>
<div id='hint'></div>
<script src='crossword.js'></script>
<script src='emojis.js'></script>
<script>
'use strict';
var useTwitterEmoji = true;
var lastSelection = null;
var selectedLetter = null;
var score = 0;
var totalWords = 0;
var startEvent = 'mousedown';
var endEvent = 'mouseup';
var moveEvent = 'mousemove';
var outEvent = 'mouseleave';
var isMouseDown = false;
var backColor = null;
var isNewGame = false;
var bgColors = '#2FABF9,#F2C03A,#DB2E29,#9280F9'.split(',');
var hiColors = 'yellow,#3BDB29,#2FABF9,#F2C03A,#DB2E29,#9280F9'.split(',');
var currentColor = 0;
//var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
var points = {"a":1,"b":3,"c":3,"d":2,"e":1,"f":4,"g":2,"h":4,"i":1,"j":8,"k":5,"l":1,"m":3,"n":1,"o":1,"p":3,"q":10,"r":1,"s":1,"t":1,"u":1,"v":4,"w":4,"x":8,"y":4,"z":10};
var words_emojis = [];
var gamew = 9;
var gameh = 9;
var nQuestions = 6;
var nFound = 0;
var matrix = {};//new Array(gameh);
var first = null;
var categories = Object.keys(emojis);
var words = [];
var found_words = [];
var category = categories[0];
var names = Object.keys(emojis[category]);

function $(id)
{
	return document.getElementById(id);
}

function rnd(n)
{
	return Math.floor(Math.random()*n);
}

function showWin(n,x,y)
{
  win.style.left = (x-64+24) + 'px';
  win.style.top = (y-64+24) + 'px';
  win.textContent = '+' + n;
  win.classList.add('zoom');
  setTimeout(function () { win.classList.remove('zoom')},900);
}

function setScore(s)
{
  try {
    window.localStorage.score = s;
  } catch (e) {}
  if (s > 1)
    highscorediv.textContent = score + ' points';
  else
    highscorediv.textContent = score + ' point';
}

function setTotalWords(s)
{
  try {
    window.localStorage.totalWords = s;
  } catch (e) {}
  if (s > 1)
    totalwordsdiv.textContent = totalWords + ' words';
  else
    totalwordsdiv.textContent = totalWords + ' word';
}

function pointsForWord(textselection)
{
  var pts = 0;
  if (!textselection)
    return 0;
  var letters = textselection.trim().toLowerCase().split('');
  for (var i=0;i<letters.length;i++)
  {
    var val = points[letters[i]];
    if (val)
      pts += val;
  }
  return pts;
}

function reHint()
{
  var newone = hint.cloneNode(true);
  hint.parentNode.replaceChild(newone, hint);
}

function init()
{
  nFound = 0;
  var elems = document.querySelectorAll('.letter');
  elems.forEach(a => delete a.dataset.done);

  currentColor = parseInt(Math.random() * hiColors.length);
  backColor = bgColors[new Date%bgColors.length];
  document.body.style.backgroundColor = backColor;
  var cwgrid = null;
  var done = false;
  while (!done)
  {
    words = [];
    found_words = [];
    words_emojis = [];
    var n = 0;
    while (n < 1000 && words.length < nQuestions)
    {
      n++;
      var idx = parseInt(Math.random()*names.length);
      var name = names[idx];
      if (name.length < gamew && name.length < gameh && name.indexOf(' ') === -1 && name.indexOf('-') !== 0 && words.indexOf(name.toUpperCase()) === -1)
      {
        var emoji = emojis[category][name];
        var up = name.toUpperCase();
        words.push(words.length +  up);
        if (useTwitterEmoji)
        {
          var hexcode = hexCodeFromEmoji(emoji);
          words_emojis.push('svg/' + hexcode + '.svg');
        }
        else
          words_emojis.push(emoji);
      }
    }
    var cw = new Crossword(words, words_emojis);
    var tries = 10; 
    cwgrid = cw.getSquareGrid(tries);

    if (cwgrid !== null)
      done = true;
  }

  matrix = {};
	for (var j=0;j<gameh;j++)
	{
		matrix[j] = new Array(gamew);
		for (var i=0;i<gamew;i++)
		{
			matrix[j][i] = ' ';
		}
	}

  for(var r=0;r<cwgrid.length;r++)
  {
    for(var c=0;c<cwgrid[r].length;c++)
    {
      var cell = cwgrid[r][c];
      var letter = ' ';
      if (cell !== null)
        letter = cell.char;
      matrix[r][c] = letter;
    }
  }

	initReal(cwgrid);
}

function hexCodeFromEmoji(emoji)
{
  var code = emoji.charCodeAt(0);
  if (emoji.length > 2)
    console.error('emoji > 3',emoji);
  if (emoji.length === 2)
  {
    code = (
            0x10000
            | ((emoji.charCodeAt(0) - 0xD800) << 10)
            | (emoji.charCodeAt(1) - 0xDC00)
        );
  }
  var hexcode = code.toString(16);
  return hexcode;
}

function initReal()
{
  var size = gamew * 48;
  
	var html = '';
  var letters = [];
	for (var j=0;j<gameh;j++)
	{
		for (var i=0;i<gamew;i++)
		{
			if (matrix[j][i] === ' ')
				continue;
			var isLetter = (matrix[j][i] >= 'A' && matrix[j][i] <= 'Z');
			//html += '<g dataset-i=' + i + ' dataset-j=' + j + ' class="group">';
			html += '<g>';
      if (isLetter)
      {
				html += '<rect fill="white" data-i='+ i + ' data-j=' + j + ' class="letter" width="46px" height="46px" x="' + (i * 48+1) + '" y="' + (j * 48+1) + '" />';
        var display = rnd(2);
        if (display === 0 && letters.length < gamew)
        {
  			  letters.push(matrix[j][i]);
	        html += '<text class="guess" x="' + (i * 48+24) + '" y="' + (j * 48+28) + '">' + matrix[j][i] + '</text>';
	      }
	      else
	      {
  	      html += '<text class="guess foundsolution" x="' + (i * 48+24) + '" y="' + (j * 48+28) + '">' + matrix[j][i] + '</text>';
	      }
	    }
	    else
	    {
		    //html += '<rect fill="transparent" class="group" width="46px" height="46px" x="' + (i * 48) + '" y="' + (j * 48) + '" />';
		    if (useTwitterEmoji)
		    {
		      html += '<image width="48" height="48" x="' + (i * 48) + '" y="' + (j * 48) + '" xlink:href="' + words_emojis[+matrix[j][i]] + '"/>';
		      //html += '<svg width=45 height=45 viewBox="0 0 45 45"><use xlink:href="' +  words_emojis[+matrix[j][i]] + '"></use></svg>';
		    }
		    else
	    	  html += '<text class="emojitext" x="' + (i * 48+24) + '" y="' + (j * 48+28) + '">' + words_emojis[+matrix[j][i]] + '</text>';
	    }
	    html += '</g>';
		}
	}
	//grid.innerHTML = html;
	var sizeh = size + 2*48;
	grid.setAttribute('viewBox','0 0 ' + size + ' ' + sizeh);

	win.style.backgroundColor = backColor;

  grid.style.opacity = 1.0;

  letters.sort(function() { return 0.5 - Math.random() });
	//html = '';
	//letters.forEach(l => html += '<span class="solutionletter">' + l + '</span>');
	var j = gameh+1;
	var x = 0;
	for (var i=0;i<letters.length;i++)
	{
	  html += '<g>';
	  //html += '<svg transition="translate 2s ease-in" x=' + (x*48) + ' y=' + (j*48) + '>';
	  html += '<rect data-letter="' + letters[i] + '" class="solutionletter" fill="white" width="46px" height="46px" x="' + (x * 48+1) + '" y="' + (j*48) + '" />';
	  html += '<text x="' + (x * 48+24) + '" y="' + (j*48+28) + '">' + letters[i] + '</text>';
	  //html += '<rect data-letter="' + letters[i] + '" class="solutionletter" fill="white" width="46px" height="46px" x="1" y="1"/>';
	  //html += '<text x="24" y="24">' + letters[i] + '</text>';
	  html += '</g>';
	  //html += '</svg>';
	  x++;
	  if ((x % gamew) === 0)
	  {
	    x = 0;
	    j++;
	  }
	}
  grid.innerHTML = html;

	grid.querySelectorAll('.letter').forEach(g => {g.addEventListener(startEvent,function(e){
	  e.preventDefault();
	  e.stopPropagation();
	  if (!e.target.dataset.i)
	    return;
	  var row = e.target.dataset.j;
	  var col = e.target.dataset.i;
	  var letter = matrix[row][col];
	  if (selectedLetter && selectedLetter.dataset.letter === letter && !e.target.parentElement.querySelector('text').classList.contains('foundsolution'))
	  {
	    var x = +e.target.getAttribute('x');
	    var y = +e.target.getAttribute('y');
	    var xnow = +selectedLetter.getAttribute('x');
	    var ynow = +selectedLetter.getAttribute('y');
	    var dx = x - xnow;
	    var dy = y - ynow - 1;
	    var g = selectedLetter.parentElement;
	    g.style.transform = 'translate(' + dx + 'px,' + dy + 'px)';
	    setTimeout(function(){g.style.display='none'},200);
	    selectedLetter = null;
	    e.target.parentElement.querySelector('text').classList.add('foundsolution');
	    e.target.classList.add('selected');
	    nFound++;
      var points = pointsForWord(letter);
      score += points;
      setScore(score);
      var rect = e.target.getBoundingClientRect();
      showWin(points,rect.left,rect.top);
	    if (nFound === letters.length)
	    {
	      restartGame();
	    }
	  }
	})});
  grid.querySelectorAll('.solutionletter').forEach(l => l.addEventListener(startEvent,function(e){
	  e.preventDefault();
	  e.stopPropagation();
	  if (selectedLetter)
	    selectedLetter.classList.remove('selected');
	  e.target.classList.add('selected');
	  selectedLetter = e.target;
	  var rect = grid.getBoundingClientRect();
	  /*var dx = e.clientX - rect.left - selectedLetter.getAttribute('x');
	  var dy = e.clientY - rect.top - selectedLetter.getAttribute('y');
	  selectedLetter.dataset.dx = dx;
	  selectedLetter.dataset.dy = dy;
	  selection.querySelector('text').textContent = selectedLetter.parentElement.querySelector('text').textContent;
	  selection.style.display='block';
	  selection.style.left = (e.clientX - dx) + 'px';
	  selection.style.top = (e.clientY - dy) + 'px';*/
  }));
  reHint();
}

function restartGame()
{
  document.querySelectorAll('rect').forEach(r => r.classList.add('highlight'));
  setTimeout(function(){
    grid.style.opacity=0;
    setTimeout(function () { init();grid.style.opacity=1; },1000);
  },900);
}

function solve()
{
  var solutions = document.querySelectorAll('.guess');
  solutions.forEach(s => s.classList.add('show'));
}

function unsolve()
{
  var solutions = document.querySelectorAll('.guess');
  solutions.forEach(s => {if (!s.classList.contains('foundsolution')) {s.classList.remove('show')}});
}

if ('ontouchstart' in document.documentElement)
{
  startEvent = 'touchstart';
  endEvent = 'touchend';
  outEvent = 'touchleave';
  moveEvent = 'touchmove';
}

document.addEventListener('keydown',function(e){
  if (e.key === 'h')
    solve();
});

document.addEventListener('keyup',function(e){
    unsolve();
});

document.body.addEventListener(startEvent,function (){init();});

/* for some reason, Chrome does not respect user-select without this */
document.body.onselectstart= function () {return false;}

grid.addEventListener(startEvent,function (e) {
  e.preventDefault();
  e.stopPropagation();
});

grid.addEventListener(endEvent,function (e) {
  e.preventDefault();
  e.stopPropagation();
});

/*document.body.addEventListener(moveEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
  if (selectedLetter === null)
    return;
  var r = selectedLetter;
  var dx = +r.dataset.dx;
  var dy = +r.dataset.dy;
  selection.style.left = e.clientX - dx;
  selection.style.top = e.clientY - dy;
});*/

totalwordsdiv.addEventListener(startEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
  solve();
});

totalwordsdiv.addEventListener(endEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
  unsolve();
});

totalwordsdiv.addEventListener(outEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
  unsolve();
});

highscorediv.addEventListener(endEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
  score = 0;
  totalWords = 0;
  setScore(score);
  setTotalWords(totalWords);
});

highscorediv.addEventListener(startEvent,function(e){
  e.preventDefault();
  e.stopPropagation();
});

try {
  if (window.localStorage && window.localStorage.score)
    score = +window.localStorage.score;
  if (window.localStorage && window.localStorage.totalWords)
    totalWords = +window.localStorage.totalWords;
} catch (e) {}

setScore(score);
setTotalWords(totalWords);
</script>
</body>
</html>
